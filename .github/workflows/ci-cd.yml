name: CI-CD

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build-docker-images:
    name: Build docker images
    runs-on: ubuntu-latest

    steps:
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Checkout code
        uses: actions/checkout@v4

      # - name: BACK END - Build
      #   run: |
      #     docker build ./backend --tag conquyhung/seal-idea-back-end \
      #       --build-arg PROD_POSTGRES_DB=${{ secrets.PROD_POSTGRES_DB }} \
      #       --build-arg PROD_POSTGRES_USERNAME=${{ secrets.PROD_POSTGRES_USERNAME }} \
      #       --build-arg PROD_POSTGRES_PASSWORD=${{ secrets.PROD_POSTGRES_PASSWORD }} \
      #       --build-arg CORS_ORIGIN_HOST=${{ secrets.CORS_ORIGIN_HOST }}

      # - name: BACK END - Tag
      #   run: docker tag conquyhung/seal-idea-back-end conquyhung/seal-idea-back-end:latest
      # - name: BACK END - Push
      #   run: docker push conquyhung/seal-idea-back-end:latest

      - name: FRONT END - Debug
        run: |
          ls -la ./frontend
          cat ./frontend/Dockerfile

      - name: FRONT END - Build
        run: |
          docker build ./frontend --tag conquyhung/seal-idea-front-end \
            --build-arg SSL_PRIVATE_KEY=${{ secrets.SSL_PRIVATE_KEY }} \
            --build-arg SSL_CRT=${{ secrets.SSL_CRT }}

  #     - name: FRONT END - Tag
  #       run: docker tag conquyhung/seal-idea-front-end conquyhung/seal-idea-front-end:latest
  #     - name: FRONT END - Push
  #       run: docker push conquyhung/seal-idea-front-end:latest

  # deploy-to-ec2:
  #   name: deploy to ec2
  #   runs-on: ubuntu-latest
  #   needs: [build-docker-images]

  #   steps:
  #     - uses: actions/checkout@v2
  #     - name: DEPLOY TO AWS - through ssh connection to ec2
  #       env:
  #         PRIVATE_KEY: ${{secrets.EC2_SSH_PRIVATE_KEY}}
  #         HOSTNAME: ${{secrets.EC2_SSH_HOST}}
  #         USER_NAME: ${{secrets.EC2_USER_NAME}}

  #       run: |
  #         echo "$PRIVATE_KEY" > private_key && chmod 600 private_key
  #         ssh -o StrictHostKeyChecking=no -i private_key ${USER_NAME}@${HOSTNAME} '
  #             # Now we have got the access of EC2 and we will start the deploy .
  #             # cd /home/ec2-user
  #             # Clean previous container and images
  #             docker stop seal-idea-back-end seal-idea-front-end
  #             docker rm seal-idea-back-end seal-idea-front-end
  #             docker rmi conquyhung/seal-idea-back-end:latest
  #             docker rmi conquyhung/seal-idea-front-end:latest
  #             # Start new container and images
  #             docker pull conquyhung/seal-idea-back-end:latest
  #             docker pull conquyhung/seal-idea-front-end:latest
  #             docker run -d --name seal-idea-back-end -p 8080:8080 conquyhung/seal-idea-back-end:latest
  #             docker run -d --name seal-idea-front-end -p 5173:5173 conquyhung/seal-idea-front-end:latest
  #             '
